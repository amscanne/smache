#!/usr/bin/env python

import smache
import sys
import os
import stat

def loadindex(filename):
    #
    # Load the index for this instance.
    #
    index = dict()
    try:
        f = open(filename + ".index", "r")
        for l in f.readlines():
            try:
                (hash, perms, filename) = l.split(' ', 2)
            except:
                continue
            filename = filename.rstrip()
            index[filename] = (hash, int(perms))
        f.close()
    except:
        pass
    return index

def saveindex(filename, index):
    #
    # Try to save the index file.
    #
    f = open(filename + ".index", "w")
    for k in index.keys():
        (hash, perms) = index[k]
        f.write("%s %d %s\n" % (hash, perms, k))
        f.flush()
    f.close()

def extract(sm, index, files):
    for file in files:
        (dirname, filename) = os.path.split(file)
        if dirname and not(os.path.exists(dirname)):
            os.makedirs(dirname, mode=0777)
        (hash, perms) = index[file]
        sm.getfile(hash, file)
        os.chmod(file, perms)

def add(sm, index, files):
    for file in files:
        if os.path.isdir(file):
            for root, dirs, files in os.walk(file):
                add(sm, index, map(lambda x: os.path.join(root, x), files))
        else:
            hash = sm.addfile(file)
            statinfo = os.stat(file)
            perms = statinfo[stat.ST_MODE]
            index[file] = (hash, perms)

def usage(args):
    print "usage: %s <x|a> <database> [files....]" % (args[0])
    print " x - Extract listed files."
    print " a - Add listed files."

def main(args):
    if len(args) < 3:
        usage(args)
        return

    #
    # Create a smache instance.
    #
    sm = smache.Smache()
    # sm.debug(True)
    backend = smache.BerkeleyDB(sm, args[2])
    # backend.debug(True)
    index = loadindex(args[2])

    #
    # Actually extract/add appropriate files.
    #
    if args[1] == "x":
        if len(args) == 3:
            extract(sm, index, index.keys())
        else:
            extract(sm, index, args[3:])

    elif args[1] == "a":
        add(sm, index, args[3:])

    saveindex(args[2], index)

if __name__ == "__main__":
    main(sys.argv)
